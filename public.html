<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visita Virtual - LOTIFY</title>
    <link rel="icon" type="image/png" href="fav.png.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5.7.3/index.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5.7.3/index.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --dark: #0f172a; }
        body { margin: 0; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        #viewer { width: 100vw; height: 100vh; background: var(--dark); }

        /* --- UI ESCITORIO --- */
        .company-logo { 
            position: fixed; top: 30px; right: 30px; z-index: 90; 
            height: 60px; width: auto; object-fit: contain; pointer-events: none; 
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); transition: 0.3s;
        }
        
        .project-header { 
            position: fixed; top: 30px; left: 30px; z-index: 90; max-width: 350px;
            animation: slideInLeft 0.5s ease-out; transition: 0.3s;
        }
        
        .project-card-header { 
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); 
            padding: 20px; border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.6);
            border-left: 5px solid var(--primary); 
        }
        
        .project-card-header h1 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--dark); line-height: 1.2; }
        .project-location { margin-top: 8px; font-size: 0.8rem; color: var(--secondary); font-weight: 600; display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
        .project-desc { margin-top: 10px; font-size: 0.85rem; color: #475569; line-height: 1.5; border-top: 1px solid #e2e8f0; padding-top: 10px; max-height: 100px; overflow-y: auto; }

        .legal-bar { position: fixed; bottom: 20px; width: 100%; z-index: 80; display: flex; justify-content: center; pointer-events: none; }
        .legal-pill { background: rgba(15, 23, 42, 0.8); padding: 6px 16px; border-radius: 30px; font-size: 0.7rem; color: white; font-weight: 600; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 6px; }
        .powered-by { position: fixed; bottom: 10px; right: 20px; z-index: 80; font-size: 0.7rem; color: rgba(255, 255, 255, 0.6); font-weight: 700; pointer-events: none; text-transform: uppercase; }

        /* --- ESTILOS MARCADORES --- */
        .psv-tooltip { background: transparent !important; box-shadow: none !important; border: none !important; }
        .psv-tooltip-content { background: transparent !important; padding: 0 !important; }

        .lote-card-nano {
            background: white; border-radius: 12px; padding: 10px 14px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); margin-bottom: 15px; position: relative;
            min-width: 120px;
        }
        .lote-card-nano::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px 6px 0; border-style: solid; border-color: white transparent transparent transparent;
        }
        .nano-status { font-size: 0.65rem; font-weight: 800; text-transform: uppercase; display: inline-block; padding: 3px 8px; border-radius: 4px; color: white; margin-bottom: 4px; }
        .nano-price { font-size: 1.1rem; font-weight: 800; color: var(--dark); display: block; }
        .nano-meta { font-size: 0.75rem; color: var(--secondary); font-weight: 600; display: block; }

        .lote-badge-content {
            background: white; color: var(--dark); border: 2px solid white;
            min-width: 26px; height: 26px; padding: 0 6px; border-radius: 13px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s; cursor: pointer;
        }
        .lote-badge-content:hover { transform: scale(1.2); z-index: 100; }

        /* --- RESPONSIVE MÓVIL --- */
        @media (max-width: 768px) {
            .company-logo { 
                height: 40px; top: 15px; right: 15px; 
                filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
            }
            
            /* Movemos la info abajo para no tapar la vista */
            .project-header {
                top: auto; bottom: 0; left: 0; width: 100%; max-width: 100%;
                animation: slideInUp 0.5s ease-out;
            }
            
            .project-card-header {
                border-radius: 20px 20px 0 0;
                border: none; border-top: 1px solid rgba(255,255,255,0.5);
                padding: 15px 20px 30px 20px; /* Padding extra abajo por el safe area */
                background: rgba(255, 255, 255, 0.98);
            }
            
            .project-card-header h1 { font-size: 1.1rem; }
            .project-desc { display: none; /* Ocultamos descripción larga en móvil */ }
            
            .legal-bar { display: none; /* Ocultamos legal bar para ganar espacio */ }
            .powered-by { display: none; }
            
            /* Ajustes marcadores móvil */
            .lote-badge-content { min-width: 32px; height: 32px; font-size: 0.9rem; } /* Más grandes para el dedo */
        }

        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="viewer"></div>
    
    <div class="project-header" id="header-container" style="display:none;">
        <div class="project-card-header">
            <h1 id="p-title">Cargando...</h1>
            <div class="project-location" id="p-location-container" style="display:none;">
                <i class="bi bi-geo-alt-fill"></i> <span id="p-location"></span>
            </div>
            <div class="project-desc" id="p-desc"></div>
        </div>
    </div>

    <img id="company-logo-img" class="company-logo" style="display:none;" alt="Logo">
    
    <div class="legal-bar">
        <div class="legal-pill">
            <i class="bi bi-info-circle"></i> Imagen referencial. Sujeto a topografía.
        </div>
    </div>
    
    <div class="powered-by">Powered by LOTIFY</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.164.0/build/three.module.js",
                "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5.7.3/index.module.js",
                "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin@5.7.3/index.module.js"
            }
        }
    </script>

    <script type="module">
        import { Viewer } from '@photo-sphere-viewer/core';
        import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

        // 1. Configuración de URL dinámica
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocal ? 'http://localhost:3000/api/public' : 'https://lotify-backend.onrender.com/api/public';
        
        // 2. Detectar Móvil para ajustar grosores
        const isMobile = window.innerWidth <= 768;
        
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('s'); 
        const TEXTS = { 1: 'DISPONIBLE', 2: 'RESERVADO', 3: 'VENDIDO' };
        
        let viewer, markersPlugin;

        // Factores de escala aumentados para móvil
        const getCaminoScale = (zoom) => (isMobile ? 0.6 : 0.3) + (0.5 * (zoom / 100)); 
        const getLoteScale = (zoom) => (isMobile ? 1.0 : 0.6) + (0.4 * (zoom / 100));

        function getPolygonCenter(points) {
            if (!points || points.length === 0) return null;
            let x = 0, y = 0, z = 0;
            points.forEach(p => {
                const yaw = p[0]; const pitch = p[1];
                x += Math.cos(pitch) * Math.cos(yaw);
                y += Math.sin(pitch);
                z += Math.cos(pitch) * Math.sin(yaw);
            });
            const len = points.length; x /= len; y /= len; z /= len;
            return [Math.atan2(z, x), Math.atan2(y, Math.sqrt(x * x + z * z))];
        }

        // Actualiza grosor al hacer zoom
        function updateAllMarkersScale() {
            if (!viewer || !markersPlugin) return;
            const currentZoom = viewer.getZoomLevel();
            const markers = markersPlugin.markers;
            
            for (const id in markers) {
                const m = markers[id];
                if (m.data) {
                    if (m.data.tipo === 'camino') {
                        const baseW = parseInt(m.data.superficie) || 15;
                        // En móvil forzamos un grosor mínimo de 6px para que se vea
                        const minW = isMobile ? 6 : 3;
                        const w = Math.max(minW, baseW * getCaminoScale(currentZoom));
                        markersPlugin.updateMarker({ id: id, svgStyle: { strokeWidth: w } });
                    } 
                    else if (m.data.tipo === 'lote') {
                        const baseW = parseInt(m.data.color_hex) || 4;
                        // En móvil grosor mínimo de 4px
                        const minW = isMobile ? 4 : 2;
                        const scaledW = Math.max(minW, baseW * getLoteScale(currentZoom));
                        markersPlugin.updateMarker({ id: id, svgStyle: { strokeWidth: scaledW } });
                    }
                }
            }
        }

        async function init() {
            if(!slug) return document.body.innerHTML = '<h2 style="color:white;text-align:center;margin-top:50px;">Proyecto no encontrado</h2>';
            
            try {
                // Cargar Proyecto
                const pRes = await fetch(`${API_URL}/project/${slug}`);
                if(!pRes.ok) throw new Error('Error cargando proyecto');
                const project = await pRes.json();

                // UI
                document.getElementById('p-title').innerText = project.nombre;
                if(project.localidad) { 
                    document.getElementById('p-location').innerText = project.localidad; 
                    document.getElementById('p-location-container').style.display = 'flex'; 
                }
                if(project.descripcion) document.getElementById('p-desc').innerText = project.descripcion;
                document.getElementById('header-container').style.display = 'flex';
                document.title = `${project.nombre} | Tour Virtual`;
                
                if (project.logo_url) { 
                    const logoImg = document.getElementById('company-logo-img'); 
                    logoImg.src = project.logo_url; 
                    logoImg.style.display = 'block'; 
                }

                // Iniciar Visor
                viewer = new Viewer({
                    container: document.getElementById('viewer'),
                    panorama: project.imagen_360_url,
                    navbar: isMobile ? ['zoom', 'fullscreen'] : ['zoom', 'autorotate', 'fullscreen'], // Menos botones en móvil
                    defaultZoomLvl: 0,
                    mousewheel: true,
                    touchmoveTwoFingers: true, // Mejor control táctil
                    plugins: [[MarkersPlugin, { markers: [] }]]
                });
                
                markersPlugin = viewer.getPlugin(MarkersPlugin);
                viewer.addEventListener('zoom-updated', updateAllMarkersScale);

                // Cargar Lotes
                const lRes = await fetch(`${API_URL}/lotes/${project.id}`);
                const elements = await lRes.json();

                elements.forEach(el => {
                    let rawData = el.poligono_json || el.coordenadas_json;
                    let puntos = typeof rawData === 'string' ? JSON.parse(rawData) : rawData;

                    if (el.tipo === 'lote') {
                        // Renderizar Lote
                        const path = Array.isArray(puntos) ? puntos : (puntos.path || []);
                        if(path.length < 2) return;
                        
                        let color = '#10b981'; // Verde
                        if(el.estado_id === 2) color = '#2563eb'; // Azul
                        if(el.estado_id === 3) color = '#ef4444'; // Rojo
                        
                        const strokeW = (el.color_hex && !isNaN(el.color_hex)) ? parseInt(el.color_hex) : 4;
                        const initialW = Math.max(isMobile ? 4 : 2, strokeW * getLoteScale(0));

                        markersPlugin.addMarker({ 
                            id: `poly_${el.id}`, 
                            polygonPixels: false, 
                            polygon: path.map(p => [p[0], p[1]]), 
                            svgStyle: { 
                                fill: el.estado_id === 1 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(255,255,255,0.0)', // Relleno sutil solo si disponible
                                stroke: 'white', 
                                strokeWidth: initialW 
                            }, 
                            data: { tipo: 'lote', color_hex: strokeW } 
                        });

                        // Badge Central
                        const center = getPolygonCenter(path);
                        if(center) {
                            let badgeStyle = el.estado_id === 1 
                                ? 'background: white; color: #1e293b; border: 2px solid #10b981;' 
                                : `background: ${color}; border: 2px solid white; color: white;`;

                            const badgeHtml = `<div class="lote-badge-wrapper"><div class="lote-badge-content" style="${badgeStyle}">${el.numero_lote}</div></div>`;
                            
                            markersPlugin.addMarker({ 
                                id: `badge_${el.id}`, 
                                position: { yaw: center[0], pitch: center[1] }, 
                                html: badgeHtml, 
                                anchor: 'center center', 
                                tooltip: { content: createNanoCard(el, color), position: 'top center', trigger: 'click' }, // Click en móvil
                                data: { tipo: 'badge' } 
                            });
                        }
                    }
                    else if (el.tipo === 'camino') {
                        // Renderizar Camino
                        const path = Array.isArray(puntos) ? puntos : (puntos.path || []);
                        if(path.length < 2) return;
                        const baseW = parseInt(el.superficie) || 15;
                        const initialW = Math.max(isMobile ? 6 : 3, baseW * getCaminoScale(0));
                        
                        markersPlugin.addMarker({ 
                            id: `camino_${el.id}`, 
                            polyline: path.map(p => [p[0], p[1]]), 
                            svgStyle: { 
                                stroke: el.color_hex || '#ffffff', 
                                strokeWidth: initialW, 
                                strokeLinecap: 'round', 
                                strokeOpacity: 0.8 
                            }, 
                            data: { tipo: 'camino', superficie: baseW } 
                        });
                    }
                });
                
                // Ajustar escala inicial
                setTimeout(updateAllMarkersScale, 100);

            } catch (error) { 
                console.error(error); 
                alert('No se pudo cargar el proyecto. Revisa tu conexión.'); 
            }
        }

        function createNanoCard(el, color) {
            const precio = parseInt(el.precio || 0).toLocaleString('es-CL');
            const sup = parseInt(el.superficie || 0).toLocaleString('es-CL');
            return `
                <div class="lote-card-nano">
                    <span class="nano-status" style="background:${color};">${TEXTS[el.estado_id]}</span>
                    <span class="nano-price">$${precio}</span>
                    <span class="nano-meta">${sup} m²</span>
                </div>
            `;
        }
        
        init();
    </script>
</body>
</html>