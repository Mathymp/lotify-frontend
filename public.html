<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visita Virtual - LOTIFY</title>
    <link rel="icon" type="image/png" href="fav.png.png">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <style>
        :root { --primary: #2563eb; --secondary: #64748b; --dark: #0f172a; }
        body { margin: 0; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; }
        #viewer { width: 100vw; height: 100vh; background: var(--dark); }

        /* --- UI HEADER (REDISEÑADO: IZQUIERDA Y MODERNO) --- */
        .company-logo { position: fixed; top: 30px; right: 30px; z-index: 100; height: 80px; width: auto; object-fit: contain; pointer-events: none; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); }
        
        .project-header { 
            position: fixed; top: 30px; 
            left: 25px; /* Alineado a la izquierda */
            z-index: 100; 
            max-width: 380px;
            display: flex; justify-content: flex-start; /* Alineación flex izquierda */
            animation: slideInLeft 0.7s cubic-bezier(0.25, 0.8, 0.25, 1); /* Animación de entrada suave desde la izquierda */
        }
        
        .project-card-header { 
            background: rgba(255, 255, 255, 0.88); /* Un poco más transparente */
            backdrop-filter: blur(12px); /* Mayor efecto cristal */
            padding: 18px 28px;
            /* Forma de cápsula asimétrica moderna: menos curva a la izq, muy curva a la derecha */
            border-radius: 16px 50px 50px 16px; 
            box-shadow: 0 10px 30px -5px rgba(0,0,0,0.1), 0 5px 10px -5px rgba(0,0,0,0.05);
            text-align: left; /* Texto a la izquierda */
            border: 1px solid rgba(255,255,255,0.5);
            border-left: 4px solid var(--primary); /* Acento de color moderno a la izquierda */
        }
        
        .project-card-header h1 { 
            margin: 0; font-size: 1.4rem;
            font-weight: 800; color: var(--dark); line-height: 1.1; letter-spacing: -0.5px;
        }
        
        .project-location { 
            margin-top: 6px; font-size: 0.8rem; color: var(--secondary); font-weight: 700; 
            display: flex; align-items: center; justify-content: flex-start; /* Icono y texto a la izquierda */
            gap: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .project-location i { color: var(--primary); font-size: 0.9rem; }
        
        .project-desc { 
            margin-top: 8px; font-size: 0.85rem; color: var(--secondary); 
            font-weight: 500; line-height: 1.4; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 8px;
        }

        /* UI FOOTER */
        .legal-bar { position: fixed; bottom: 20px; width: 100%; z-index: 80; display: flex; justify-content: center; pointer-events: none; }
        .legal-pill { background: rgba(0, 0, 0, 0.75); padding: 8px 20px; border-radius: 30px; font-size: 0.7rem; color: white; font-weight: 700; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(4px); display: flex; align-items: center; gap: 8px; text-align: center; }
        .powered-by { position: fixed; bottom: 8px; right: 20px; z-index: 100; font-size: 0.8rem; color: rgba(255, 255, 255, 0.8); font-weight: 800; pointer-events: none; text-transform: uppercase; letter-spacing: 1px; text-shadow: none; }

        /* MARCADORES LIMPIOS */
        .psv-marker-svg, .polygon-marker { filter: none !important; box-shadow: none !important; drop-shadow: none !important; }
        .psv-tooltip { background: transparent !important; box-shadow: none !important; border: none !important; padding: 0 !important; }
        .psv-tooltip-content { background: transparent !important; padding: 0 !important; border-radius: 0 !important; }

        /* TARJETA DE LOTE "NANO" */
        .lote-card-nano {
            background: white; border-radius: 12px; padding: 8px 12px;
            text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            margin-bottom: 12px; white-space: nowrap; position: relative; text-shadow: none !important;
        }
        .lote-card-nano::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px 5px 0; border-style: solid; border-color: white transparent transparent transparent;
        }

        /* ESTILO PASTILLA */
        .nano-status { 
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; 
            display: inline-block; margin-bottom: 4px; color: white !important; 
            padding: 4px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            text-shadow: none !important;
        }

        .nano-price { font-size: 1.1rem; font-weight: 700; color: var(--dark); line-height: 1.1; display: block; text-shadow: none !important; }
        .nano-meta { font-size: 0.7rem; color: var(--secondary); font-weight: 600; display: block; margin-top: 2px; text-shadow: none !important; }

        /* --- ESTILOS TRAÍDOS DEL EDITOR (VISOR.CSS) --- */

        /* BADGES (NÚMEROS DE LOTE) */
        .lote-badge-wrapper { width: 0; height: 0; position: absolute; pointer-events: none; overflow: visible; z-index: 100; }
        
        .lote-badge-content {
            position: absolute; top: 0; left: 0; transform: translate(-50%, -50%);
            /* Estilo del Editor: Más grande y legible */
            min-width: 28px; height: 28px; padding: 0 8px;
            border-radius: 50px; display: flex; align-items: center; justify-content: center;
            font-weight: 800; font-size: 0.9rem; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); white-space: nowrap; 
            pointer-events: auto; cursor: pointer; transition: transform 0.2s ease-out;
            text-shadow: none !important; /* Limpieza extra */
        }
        .lote-badge-content:hover { transform: translate(-50%, -50%) scale(1.2); z-index: 101; }

        /* POI (PUNTOS DE INTERÉS) - Estilo Editor */
        .poi-wrapper { width: 0; height: 0; position: absolute; overflow: visible; pointer-events: none; }
        .poi-content {
            position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; align-items: center; width: max-content;
            pointer-events: auto; cursor: pointer; transition: transform 0.2s ease-out;
            text-shadow: none !important;
        }
        .poi-head { z-index: 10; margin-bottom: -2px; transition: transform 0.2s ease-out; }
        
        .poi-pill {
            min-width: 100px; padding: 8px 16px; border-radius: 12px; 
            text-align: center; color: white; font-weight: 700; font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        
        .poi-sub { font-size: 0.75rem; font-weight: 400; opacity: 0.95; margin-top: 2px; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .poi-line { width: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 1; margin-bottom: -4px; }
        .poi-anchor { width: 16px; height: 16px; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.5); z-index: 2; }
        
        /* Orientación y Tamaños */
        .poi-content.right .poi-head { transform: translateX(30px); }
        .poi-content.left .poi-head { transform: translateX(-30px); }
        .poi-content.size-1 { transform: translateX(-50%) scale(0.6); transform-origin: bottom center; }
        .poi-content.size-2 { transform: translateX(-50%) scale(0.8); transform-origin: bottom center; }
        .poi-content.size-3 { transform: translateX(-50%) scale(1.1); transform-origin: bottom center; }

        /* Nueva animación de entrada desde la izquierda */
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body>
    <div id="viewer"></div>
    <div class="project-header" id="header-container" style="display:none;">
        <div class="project-card-header">
            <h1 id="p-title">Cargando...</h1>
            <div class="project-location" id="p-location-container" style="display:none;"><i class="bi bi-geo-alt-fill"></i> <span id="p-location"></span></div>
            <div class="project-desc" id="p-desc"></div>
        </div>
    </div>
    <img id="company-logo-img" class="company-logo" style="display:none;" alt="Logo">
    <div class="legal-bar">
        <div class="legal-pill"><i class="bi bi-exclamation-triangle-fill" style="color:white; font-size: 0.9rem;"></i> Imágenes y deslindes referenciales. Sujeto a topografía final.</div>
    </div>
    <div class="powered-by">Powered by LOTIFY</div>

    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three/build/three.module.js", "@photo-sphere-viewer/core": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core/index.module.js", "@photo-sphere-viewer/markers-plugin": "https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/markers-plugin/index.module.js" } }</script>
    <script type="module">
        import { Viewer } from '@photo-sphere-viewer/core';
        import { MarkersPlugin } from '@photo-sphere-viewer/markers-plugin';

        // FIX: Reemplazamos localhost por la URL de Render para la API pública
        const API_URL = 'https://lotify-backend.onrender.com/api/public';
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('s'); 
        const TEXTS = { 1: 'DISPONIBLE', 2: 'RESERVADO', 3: 'VENDIDO' };
        let viewer, markersPlugin;

        const getCaminoScale = (zoom) => 0.3 + (0.5 * (zoom / 100)); 
        const getLoteScale = (zoom) => 0.6 + (0.4 * (zoom / 100));

        function getPolygonCenter(points) {
            if (!points || points.length === 0) return null;
            let x = 0, y = 0, z = 0;
            points.forEach(p => {
                const yaw = p[0]; const pitch = p[1];
                x += Math.cos(pitch) * Math.cos(yaw);
                y += Math.sin(pitch);
                z += Math.cos(pitch) * Math.sin(yaw);
            });
            const len = points.length; x /= len; y /= len; z /= len;
            return [Math.atan2(z, x), Math.atan2(y, Math.sqrt(x * x + z * z))];
        }

        function updateAllMarkersScale() {
            if (!viewer || !markersPlugin) return;
            const currentZoom = viewer.getZoomLevel();
            const markers = markersPlugin.markers;
            for (const id in markers) {
                const m = markers[id];
                if (m.data) {
                    if (m.data.tipo === 'camino') {
                        const baseW = parseInt(m.data.superficie) || 15;
                        const w = Math.max(3, baseW * getCaminoScale(currentZoom));
                        markersPlugin.updateMarker({ id: id, svgStyle: { strokeWidth: w, strokeLinecap: 'round' } });
                    } else if (m.data.tipo === 'lote') {
                        const baseW = parseInt(m.data.color_hex) || 4;
                        const scaledW = Math.max(2, baseW * getLoteScale(currentZoom));
                        markersPlugin.updateMarker({ id: id, svgStyle: { strokeWidth: scaledW } });
                    } else if (m.data.tipo === 'badge') {
                        const textScale = 0.7 + (0.3 * (currentZoom / 100)); 
                        const el = document.querySelector(`#psv-marker-${id} .lote-badge-content`);
                        if(el) el.style.transform = `translate(-50%, -50%) scale(${textScale})`;
                    }
                }
            }
        }

        async function init() {
            if(!slug) return alert('Proyecto no especificado');
            try {
                // FIX: Reemplazar fetch local por fetch a API_URL
                const pRes = await fetch(`${API_URL}/project/${slug}`);
                if(!pRes.ok) throw new Error('Proyecto no encontrado');
                const project = await pRes.json();

                document.getElementById('p-title').innerText = project.nombre;
                if(project.localidad) { document.getElementById('p-location').innerText = project.localidad; document.getElementById('p-location-container').style.display = 'flex'; }
                if(project.descripcion) document.getElementById('p-desc').innerText = project.descripcion;
                document.getElementById('header-container').style.display = 'flex';
                document.title = `${project.nombre} | Visita Virtual`;
                if (project.logo_url) { const logoImg = document.getElementById('company-logo-img'); logoImg.src = project.logo_url; logoImg.style.display = 'block'; }

                viewer = new Viewer({
                    container: document.getElementById('viewer'),
                    panorama: project.imagen_360_url,
                    navbar: false, defaultZoomLvl: 0, mousewheel: true,
                    plugins: [[MarkersPlugin, { markers: [] }]]
                });
                markersPlugin = viewer.getPlugin(MarkersPlugin);
                viewer.addEventListener('zoom-updated', updateAllMarkersScale);

                // FIX: Reemplazar fetch local por fetch a API_URL
                const lRes = await fetch(`${API_URL}/lotes/${project.id}`);
                const elements = await lRes.json();

                elements.forEach(el => {
                    let rawData = el.poligono_json || el.coordenadas_json;
                    let puntos = rawData;
                    if(typeof puntos === 'string') { try { puntos = JSON.parse(puntos); } catch(e){ return; } }

                    if (el.tipo === 'poi') {
                        const data = puntos;
                        if(!data || typeof data.yaw === 'undefined') return;
                        const h = data.height || 100; const bg = data.bg || '#ef4444'; const txt = data.text || '#ffffff';
                        const sizeClass = data.size || 2; const orient = data.orient || 'right';
                        const descHtml = el.descripcion ? `<span class="poi-sub" style="color:${txt}CC">${el.descripcion}</span>` : '';
                        
                        // HTML COPIADO DE VISOR.CSS PARA COHERENCIA
                        const html = `<div class="poi-wrapper"><div class="poi-content ${orient} size-${sizeClass}"><div class="poi-head"><div class="poi-pill" style="background:${bg}; color:${txt};"><div style="line-height:1.2">${el.titulo}</div>${descHtml}</div></div><div class="poi-line" style="height: ${h}px; background:${bg};"></div><div class="poi-anchor" style="background:${bg};"></div></div></div>`;
                        
                        markersPlugin.addMarker({ id: `poi_${el.id}`, position: { yaw: data.yaw, pitch: data.pitch }, html: html, anchor: 'center center', data: { tipo: 'poi' } });
                    } 
                    else if (el.tipo === 'camino') {
                        const path = Array.isArray(puntos) ? puntos : (puntos && puntos.path ? puntos.path : []);
                        if(path.length < 2) return;
                        const baseW = parseInt(el.superficie) || 15;
                        const initialW = Math.max(3, baseW * getCaminoScale(0));
                        markersPlugin.addMarker({ id: `camino_${el.id}`, polyline: path.map(p => [p[0], p[1]]), svgStyle: { stroke: el.color_hex || '#ffffff', strokeWidth: initialW, strokeLinecap: 'round', strokeOpacity: 0.8 }, data: { tipo: 'camino', superficie: baseW, color_hex: el.color_hex } });
                    }
                    else if(el.tipo === 'lote') {
                        const path = Array.isArray(puntos) ? puntos : (puntos && puntos.path ? puntos.path : []);
                        if(path.length < 2) return;
                        let color = '#10b981'; if(el.estado_id === 2) color = '#2563eb'; if(el.estado_id === 3) color = '#ef4444'; 
                        const strokeW = (el.color_hex && !isNaN(el.color_hex)) ? parseInt(el.color_hex) : 4;
                        const initialW = Math.max(2, strokeW * getLoteScale(0));

                        markersPlugin.addMarker({ id: `poly_${el.id}`, polygonPixels: false, polygon: path.map(p => [p[0], p[1]]), svgStyle: { fill: 'rgba(255,255,255,0.0)', stroke: 'white', strokeWidth: initialW }, data: { tipo: 'lote', color_hex: strokeW } });

                        const center = getPolygonCenter(path);
                        if(center) {
                            let badgeStyle = el.estado_id === 1 ? 'background: white; color: #1e293b; border: 2px solid white;' : `background: ${color}; border: 2px solid white; color: white;`;
                            
                            // HTML ACTUALIZADO AL ESTILO DE VISOR.CSS
                            const badgeHtml = `<div class="lote-badge-wrapper"><div class="lote-badge-content" style="${badgeStyle}">${el.numero_lote}</div></div>`;
                            
                            markersPlugin.addMarker({ 
                                id: `badge_${el.id}`, position: { yaw: center[0], pitch: center[1] }, 
                                html: badgeHtml, anchor: 'center center', 
                                tooltip: { content: createNanoCard(el, color), position: 'top center' }, 
                                data: { tipo: 'badge' } 
                            });
                        }
                    } 
                });
                updateAllMarkersScale();
            } catch (error) { console.error(error); alert('Error al cargar proyecto'); }
        }

        function createNanoCard(el, color) {
            const precio = parseInt(el.precio || 0).toLocaleString('es-CL');
            const sup = parseInt(el.superficie || 0).toLocaleString('es-CL');
            return `
                <div class="lote-card-nano">
                    <span class="nano-status" style="background:${color};">${TEXTS[el.estado_id]}</span>
                    <span class="nano-price">$${precio}</span>
                    <span class="nano-meta">${sup} m²</span>
                </div>
            `;
        }
        init();
    </script>
</body>
</html>
