<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - LOTIFY</title>
    <link rel="icon" type="image/png" href="fav.png.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* CLASES PARA CONTROL DE ROLES */
        .admin-only, .admin-only-menu { display: none !important; }

        /* ESTILOS MODALES PREMIUM */
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-card { background: white; width: 100%; max-width: 500px; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-height: 90vh; display: flex; flex-direction: column; transform: translateY(20px); transition: transform 0.3s; }
        .modal-overlay.show .modal-card { transform: translateY(0); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 25px; }

        /* BOTONES DE ACCIÓN */
        .btn-icon-action { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; transition: 0.2s; }
        .btn-edit { background: #eff6ff; color: #2563eb; }
        .btn-edit:hover { background: #2563eb; color: white; transform: translateY(-2px); }
        .btn-del { background: #fee2e2; color: #ef4444; }
        .btn-del:hover { background: #ef4444; color: white; transform: translateY(-2px); }

        /* VALIDACIÓN RUT Y FEEDBACK */
        .input-error { border-color: #ef4444 !important; background-color: #fef2f2 !important; }
        .input-success { border-color: #10b981 !important; background-color: #f0fdf4 !important; }
        .validation-msg { font-size: 0.75rem; margin-top: 4px; font-weight: 600; display: none; }
        .msg-error { color: #ef4444; }

        /* Botón de Peligro en Modal */
        .btn-danger-action { background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-danger-action:hover { background: #dc2626; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header"><a href="dashboard.html" class="logo-text" style="text-decoration:none;"><i class="bi bi-bounding-box-circles"></i> LOTI<span>FY</span></a></div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="sidebar-link"><i class="bi bi-grid-fill"></i> Mis Proyectos</a></li>
                <li class="admin-only-menu"><a href="gestion-lotes.html" class="sidebar-link"><i class="bi bi-list-check"></i> Gestión Lotes</a></li>

                <li><a href="#" class="sidebar-link active"><i class="bi bi-people-fill"></i> Clientes</a></li>
                <li><a href="ventas.html" class="sidebar-link"><i class="bi bi-currency-dollar"></i> Ventas & Visitas</a></li>
                
                <li class="admin-only-menu"><a href="configuracion.html" class="sidebar-link"><i class="bi bi-gear"></i> Configuración</a></li>
                <li class="admin-only-menu"><a href="equipo.html" class="sidebar-link"><i class="bi bi-shield-lock"></i> Equipo</a></li>

            </ul>
            <div class="sidebar-footer">
                <button class="btn-logout" onclick="localStorage.removeItem('userToken');window.location.href='index.html'"><i class="bi bi-box-arrow-left"></i> Salir</button>
            </div>
        </aside>

        <main class="admin-content">
            <div class="dashboard-header">
                <h1 class="page-title">Cartera de Clientes</h1>
                <button class="btn-primary-block" style="width: auto; margin:0;" onclick="openModal('cliente')"><i class="bi bi-person-plus-fill"></i> Nuevo Cliente</button>
            </div>
            <div class="table-responsive">
                <table class="management-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>RUT</th>
                            <th>Contacto</th>
                            <th>Notas</th>
                            <th>Registro</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clients-table-body">
                        <tr><td colspan="6" style="text-align:center; padding:30px;">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="modal-cliente" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <h3 id="modal-title">Nuevo Cliente</h3>
                <button class="btn-close" onclick="closeModal('cliente')"><i class="bi bi-x-lg"></i></button>
            </div>
            <form id="form-cliente">
                <input type="hidden" id="client-id" name="id">
                <div class="modal-body">
                    <div class="input-group">
                        <label>Nombre Completo</label>
                        <input type="text" class="styled-input" id="input-nombre" name="nombre" required placeholder="Ej. Juan Pérez">
                    </div>
                    <div class="input-group">
                        <label>RUT</label>
                        <input type="text" class="styled-input" id="input-rut" name="rut" placeholder="12.345.678-9" oninput="validateAndFormat(this)" maxlength="12">
                        <div id="rut-feedback" class="validation-msg msg-error">RUT Inválido</div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div class="input-group"><label>Email</label><input type="email" class="styled-input" id="input-email" name="email"></div>
                        <div class="input-group"><label>Teléfono</label><input type="text" class="styled-input" id="input-telefono" name="telefono"></div>
                    </div>
                    <div class="input-group"><label>Notas</label><textarea class="styled-input" id="input-notas" name="notas" rows="2" placeholder="Preferencias..."></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal('cliente')">Cancelar</button>
                    <button type="submit" class="btn-primary-block" style="width:auto; margin:0;" id="btn-save">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-delete" class="modal-overlay">
        <div class="modal-card" style="max-width: 400px;">
            <div class="modal-header">
                <h3 style="color:#ef4444; font-size:1.1rem;"><i class="bi bi-exclamation-triangle-fill"></i> Eliminar Cliente</h3>
                <button class="btn-close" onclick="closeModal('delete')"><i class="bi bi-x-lg"></i></button>
            </div>
            <div class="modal-body">
                <p style="font-weight:600; color:#1e293b; margin-bottom:5px;">¿Estás seguro de eliminar a este cliente?</p>
                <p style="font-size: 0.9rem; color: #64748b;">Esta acción borrará sus datos y su historial. No se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('delete')">Cancelar</button>
                <button type="button" class="btn-danger-action" id="btn-confirm-delete" onclick="confirmDelete()">Eliminar</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        const API_URL = 'https://lotify-backend.onrender.com/api'; // Inyección de URL de Render
        const token = localStorage.getItem('userToken');
        if(!token) window.location.href = 'index.html';
        
        let allClients = [];
        let isRutValid = false;
        let clientToDeleteId = null;
        let currentUserRole = 'vendedor'; 

        // 1. VERIFICAR ROL Y CARGAR MENÚ
        // FIX: Reemplazar fetch local por fetch a API_URL
        fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json())
            .then(user => {
                currentUserRole = user.rol || 'vendedor';
                if(currentUserRole === 'admin') {
                    document.querySelectorAll('.admin-only-menu').forEach(el => el.classList.remove('admin-only-menu'));
                }
                loadClientes();
            });

        // --- VALIDACIÓN RUT (MÓDULO 11) ---
        function checkModulo11(rut) {
            let valor = rut.replace(/\./g, '').replace(/-/g, '');
            let cuerpo = valor.slice(0, -1);
            let dv = valor.slice(-1).toUpperCase();
            if (cuerpo.length < 7) return false;
            let suma = 0, multiplo = 2;
            for (let i = 1; i <= cuerpo.length; i++) {
                let index = multiplo * valor.charAt(cuerpo.length - i);
                suma += index;
                multiplo = multiplo < 7 ? multiplo + 1 : 2;
            }
            let dvEsperado = 11 - (suma % 11);
            dvEsperado = (dvEsperado == 11) ? "0" : (dvEsperado == 10) ? "K" : dvEsperado.toString();
            return dv === dvEsperado;
        }

        function validateAndFormat(input) {
            const feedback = document.getElementById('rut-feedback');
            let valor = input.value.replace(/[^0-9kK]/g, ""); 
            input.value = valor;
            if (valor.length > 1) {
                const cuerpo = valor.slice(0, -1);
                const dv = valor.slice(-1).toUpperCase();
                input.value = cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + dv;
            }
            if (valor.length < 8) {
                input.classList.remove('input-error', 'input-success');
                feedback.style.display = 'none'; isRutValid = false; return;
            }
            if (checkModulo11(input.value)) {
                input.classList.remove('input-error'); input.classList.add('input-success');
                feedback.style.display = 'none'; isRutValid = true;
            } else {
                input.classList.remove('input-success'); input.classList.add('input-error');
                feedback.style.display = 'block'; feedback.innerText = "RUT Inválido"; isRutValid = false;
            }
        }

        // --- GESTIÓN DE MODALES ---
        function openModal(type, id = null) {
            if (type === 'cliente') {
                const modal = document.getElementById('modal-cliente');
                const title = document.getElementById('modal-title');
                const btn = document.getElementById('btn-save');
                document.getElementById('form-cliente').reset();
                document.getElementById('input-rut').classList.remove('input-error', 'input-success');
                document.getElementById('rut-feedback').style.display = 'none';
                isRutValid = false;

                if (id) {
                    const client = allClients.find(c => c.id === id);
                    if(client) {
                        document.getElementById('client-id').value = client.id;
                        document.getElementById('input-nombre').value = client.nombre;
                        document.getElementById('input-rut').value = client.rut || '';
                        document.getElementById('input-email').value = client.email || '';
                        document.getElementById('input-telefono').value = client.telefono || '';
                        document.getElementById('input-notas').value = client.notas || '';
                        if(client.rut) validateAndFormat(document.getElementById('input-rut')); else isRutValid = true;
                        title.innerText = "Editar Cliente"; btn.innerText = "Guardar Cambios";
                    }
                } else {
                    document.getElementById('client-id').value = '';
                    title.innerText = "Nuevo Cliente"; btn.innerText = "Crear Cliente";
                }
                modal.classList.add('show');
            } else if (type === 'delete') {
                clientToDeleteId = id;
                document.getElementById('modal-delete').classList.add('show');
            }
        }

        function closeModal(type) { 
            document.getElementById(`modal-${type}`).classList.remove('show'); 
            if(type === 'delete') clientToDeleteId = null;
        }

        // --- LÓGICA DE ELIMINACIÓN ---
        async function confirmDelete() {
            if(!clientToDeleteId) return;
            const btn = document.getElementById('btn-confirm-delete');
            const originalText = btn.innerText;
            btn.innerText = 'Eliminando...'; btn.disabled = true;

            try {
                // FIX: Reemplazar fetch local por fetch a API_URL
                const res = await fetch(`${API_URL}/crm/clientes/${clientToDeleteId}`, {
                    method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if(!res.ok) {
                    throw new Error('Error al eliminar. Verifique que no tenga ventas o visitas asociadas.');
                }
                loadClientes(); closeModal('delete');
            } catch(e) { alert(e.message); } 
            finally { btn.innerText = originalText; btn.disabled = false; }
        }

        // --- CARGAR CLIENTES ---
        async function loadClientes() {
            try {
                // FIX: Reemplazar fetch local por fetch a API_URL
                const res = await fetch(`${API_URL}/crm/clientes`, { headers: { 'Authorization': `Bearer ${token}` } });
                allClients = await res.json();
                const tbody = document.getElementById('clients-table-body');
                tbody.innerHTML = '';
                
                if(allClients.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="padding:40px; text-align:center; color:#94a3b8;">Sin clientes registrados.</td></tr>'; return; }

                allClients.forEach(c => {
                    const inicial = c.nombre.charAt(0).toUpperCase();
                    
                    // BOTONES DINÁMICOS
                    let btns = `<button class="btn-icon-action btn-edit" onclick="openModal('cliente', ${c.id})" title="Editar Cliente"><i class="bi bi-pencil-square"></i></button>`;
                    
                    // Solo Admin puede borrar
                    if (currentUserRole === 'admin') {
                        btns += `<button class="btn-icon-action btn-del" onclick="openModal('delete', ${c.id})" title="Eliminar Cliente"><i class="bi bi-trash-fill"></i></button>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><div style="display:flex; align-items:center; gap:12px;"><div style="width:36px; height:36px; background:#eff6ff; color:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700;">${inicial}</div><span style="font-weight:600; color:#0f172a;">${c.nombre}</span></div></td>
                            <td style="font-weight:600; color:#64748b;">${c.rut || '-'}</td>
                            <td><div style="font-size:0.85rem;"><i class="bi bi-envelope"></i> ${c.email || '-'}</div><div style="font-size:0.8rem; color:#94a3b8; margin-top:2px;"><i class="bi bi-telephone"></i> ${c.telefono || '-'}</div></td>
                            <td style="color:#64748b; font-size:0.85rem; max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${c.notas || '-'}</td>
                            <td style="color:#94a3b8; font-size:0.8rem;">${new Date(c.creado_en).toLocaleDateString()}</td>
                            <td style="text-align:center; display:flex; justify-content:center;">${btns}</td>
                        </tr>
                    `;
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('form-cliente').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (document.getElementById('input-rut').value.length > 0 && !isRutValid) return;
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            const id = document.getElementById('client-id').value;
            const btn = document.getElementById('btn-save');
            
            btn.disabled = true; btn.innerText = "Guardando...";

            try {
                let url = `${API_URL}/crm/clientes`; // FIX: Usar API_URL
                let method = 'POST';
                if(id) { url += `/${id}`; method = 'PUT'; }
                
                // FIX: Reemplazar fetch local por fetch a API_URL
                await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data) });
                closeModal('cliente'); loadClientes();
            } catch(err) { alert('Error al guardar'); } 
            finally { btn.disabled = false; btn.innerText = "Guardar Cliente"; }
        });
    </script>
</body>
</html>