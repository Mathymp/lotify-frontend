<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - LOTIFY</title>
    <link rel="icon" type="image/png" href="fav.png.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* MODALES PREMIUM */
        .modal-overlay { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); align-items: flex-start; padding-top: 5vh; }
        .modal-card { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { flex-shrink: 0; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 15px; }

        /* Estilos espec铆ficos ventas */
        .btn-icon-info {
            width: 34px; height: 34px; border-radius: 8px; border: none; cursor: pointer;
            background: #e0f2fe; color: #0284c7; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn-icon-info:hover { background: #0284c7; color: white; transform: scale(1.05); }

        .tabs-header { display: flex; gap: 20px; border-bottom: 2px solid #e2e8f0; margin-bottom: 20px; }
        .tab-btn { background: none; border: none; padding: 10px 0; font-size: 1rem; font-weight: 600; color: #94a3b8; cursor: pointer; position: relative; }
        .tab-btn.active { color: var(--primary); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }

        .admin-only { display: none !important; }
        
        /* ... resto de estilos de ventas.html original ... */
        .switch-group { background: #f1f5f9; padding: 4px; border-radius: 12px; display: flex; margin-bottom: 20px; gap: 5px; }
        .switch-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: transparent; font-weight: 600; color: #64748b; cursor: pointer; transition: 0.2s; font-size: 0.85rem; }
        .switch-btn.active { box-shadow: 0 2px 5px rgba(0,0,0,0.05); color: white; }
        #btn-type-visita.active { background: var(--primary); }
        #btn-type-reserva.active { background: #f59e0b; }
        #btn-type-venta.active { background: #10b981; }
        .price-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 15px; margin-top: 10px; }
        .price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.9rem; color: #64748b; }
        .price-row.total { border-top: 1px solid #cbd5e1; padding-top: 10px; margin-top: 10px; color: #0f172a; font-weight: 700; font-size: 1.1rem; }
        .price-val { font-family: monospace; font-size: 1rem; }
        .tag-info { font-size: 0.7rem; background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        .reserva-alert { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 15px; display: none; align-items: center; gap: 10px; }
        .filters-bar { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
        .filter-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 0.9rem; min-width: 200px; color: #64748b; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header"><a href="dashboard.html" class="logo-text" style="text-decoration:none;"><i class="bi bi-bounding-box-circles"></i> LOTI<span>FY</span></a></div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html" class="sidebar-link"><i class="bi bi-grid-fill"></i> Mis Proyectos</a></li>
                <li><a class="sidebar-link admin-only-menu" href="gestion-lotes.html" class="sidebar-link"><i class="bi bi-list-check"></i> Gesti贸n Lotes</a></li>
                <li><a href="clientes.html" class="sidebar-link"><i class="bi bi-people"></i> Clientes</a></li>
                <li><a href="#" class="sidebar-link active"><i class="bi bi-currency-dollar"></i> Ventas & Visitas</a></li>
                <li><a class="sidebar-link admin-only-menu" href="configuracion.html" class="sidebar-link"><i class="bi bi-gear"></i> Configuraci贸n</a></li>
                                <li><a href="equipo.html" class="sidebar-link admin-only-menu"><i class="bi bi-shield-lock"></i> Equipo</a></li>

            </ul>
            <div class="sidebar-footer"><button class="btn-logout" onclick="localStorage.removeItem('userToken');window.location.href='index.html'"><i class="bi bi-box-arrow-left"></i> Salir</button></div>
        </aside>

        <main class="admin-content">
            <div class="dashboard-header">
                <div><h1 class="page-title">Gesti贸n Comercial</h1><p style="color:#64748b;">Control total de visitas, reservas y cierres.</p></div>
                <button class="btn-primary-block" style="width: auto; margin:0;" onclick="openCRMModal()"><i class="bi bi-plus-circle-fill"></i> Nueva Acci贸n</button>
            </div>
            
            <div class="filters-bar">
                <i class="bi bi-funnel-fill" style="color:#94a3b8;"></i>
                <select id="filter-proyecto" class="filter-select" onchange="applyFilters()"><option value="">Todos los Proyectos</option></select>
            </div>

            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('visitas')"> Agenda</button>
                <button class="tab-btn" onclick="switchTab('ventas')"> Operaciones</button>
            </div>

            <div id="tab-visitas" class="tab-content active"><div class="projects-grid" id="visitas-grid"></div></div>

            <div id="tab-ventas" class="tab-content">
                <div class="table-responsive">
                    <table class="management-table">
                        <thead>
                            <tr>
                                <th>Fecha</th><th>Tipo</th><th>Cliente</th><th>Proyecto</th><th>Lote</th>
                                <th style="text-align: right;">Total Op.</th>
                                <th style="text-align: right;">Pagado</th>
                                <th style="text-align: center;">Info</th>
                            </tr>
                        </thead>
                        <tbody id="ventas-tbody"><tr><td colspan="8" style="text-align:center; padding:30px;">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="modal-crm" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><h3>Registrar Acci贸n</h3><button class="btn-close" onclick="closeModal('crm')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body">
                <div class="switch-group">
                    <button class="switch-btn active" onclick="setType('visita')" id="btn-type-visita">Visita</button>
                    <button class="switch-btn" onclick="setType('reserva')" id="btn-type-reserva">Reserva</button>
                    <button class="switch-btn" onclick="setType('venta')" id="btn-type-venta">Venta Final</button>
                </div>
                <form id="crm-form">
                    <input type="hidden" id="action-type" value="visita">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="input-group"><label>Proyecto</label><select id="select-proyecto" class="styled-input" onchange="loadLotes(this.value)" required><option value="">Selecciona...</option></select></div>
                        <div class="input-group" id="group-lote"><label>Lote</label><select id="select-lote" class="styled-input" onchange="handleLoteChange()" disabled><option value="">Esperando...</option></select></div>
                    </div>
                    <div id="reserva-found-msg" class="reserva-alert"><i class="bi bi-info-circle-fill"></i><span>隆Reserva encontrada! Datos cargados.</span></div>
                    <div class="input-group"><label>Cliente <a href="clientes.html" style="float:right; font-size:0.75rem; color:var(--primary); text-decoration:none;">+ Nuevo</a></label><select id="select-cliente" class="styled-input" required><option value="">Cargando...</option></select></div>
                    
                    <div id="fields-visita">
                        <label style="display:block; margin-bottom:5px; font-weight:600; font-size:0.85rem; color:#334155;">Fecha y Hora</label>
                        <div class="datetime-wrapper" style="display:flex;gap:10px;"><input type="text" id="fecha-input" class="styled-input" placeholder="Fecha"><input type="text" id="hora-input" class="styled-input" placeholder="Hora" style="max-width:120px;"></div>
                    </div>

                    <div id="fields-finance" style="display:none;">
                        <div class="price-box">
                            <div class="price-row"><span>Precio de Lista <span class="tag-info">Original</span></span><span class="price-val" id="disp-precio-lista">$0</span></div>
                            <div class="input-group" id="group-precio-acordado" style="margin-bottom:10px;"><label style="font-size:0.8rem;">Precio Acordado (Opcional)</label><input type="text" id="input-precio-acordado" class="styled-input" placeholder="$0" oninput="formatInput(this); updateCalculations()"></div>
                            <div class="input-group" id="group-monto-reserva" style="margin-bottom:10px;"><label style="font-size:0.8rem;" id="label-reserva">Monto Reserva</label><input type="text" id="input-monto-reserva" class="styled-input" placeholder="$0" oninput="formatInput(this); updateCalculations()"></div>
                            <div class="price-row total"><span id="label-total">Total a Pagar Hoy:</span><span class="price-val" id="disp-total-pagar" style="color:var(--primary);">$0</span></div>
                        </div>
                        <div class="input-group" style="margin-top:15px;"><label>M茅todo de Pago</label><select id="metodo-pago" class="styled-input"><option value="transferencia">Transferencia</option><option value="efectivo">Efectivo</option><option value="credito">Cr茅dito Hipotecario</option></select></div>
                    </div>

                    <div class="input-group" style="margin-top:10px;"><label>Notas</label><textarea id="notas" class="styled-input" rows="2" placeholder="Detalles..."></textarea></div>
                    <button type="submit" class="btn-primary-block" style="margin-top:15px;">Guardar Registro</button>
                </form>
            </div>
        </div>
    </div>

    <div id="modal-info" class="modal-overlay">
        <div class="modal-card" style="max-width:400px;">
            <div class="modal-header"><h3>Detalle Operaci贸n</h3><button class="btn-close" onclick="closeModal('info')"><i class="bi bi-x-lg"></i></button></div>
            <div class="modal-body" id="info-body"></div>
            <div class="modal-footer"><button class="btn-secondary" style="width:100%;" onclick="closeModal('info')">Cerrar</button></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script> 
    <script src="js/api.js"></script>
    <script>
        const API_URL = 'https://lotify-backend.onrender.com/api'; // Inyecci贸n de URL de Render
        const token = localStorage.getItem('userToken');
        if(!token) window.location.href = 'index.html';

        let lotesData = []; 
        let ventasData = []; 
        let visitasData = [];
        let currentTab = 'visitas';
        let currentUserRole = 'vendedor';

        // 1. CARGAR PERFIL
        // FIX: Reemplazar fetch local por fetch a API_URL
        fetch(`${API_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(r => r.json())
            .then(user => {
                currentUserRole = user.rol || 'vendedor';
                // FIX SIDEBAR: Ocultar si no es admin
                if(currentUserRole !== 'admin') {
                    document.querySelectorAll('.admin-only-menu').forEach(el => el.style.display = 'none');
                }
                loadInitialData(); // Iniciar app
                fetchAllData();
            })
            .catch(() => {});

        flatpickr("#fecha-input", { locale: "es", dateFormat: "Y-m-d", minDate: "today", defaultDate: new Date() });
        flatpickr("#hora-input", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true, defaultDate: "12:00" });

        // Utils Matem谩ticas
        function parseDB(val) { return Math.floor(parseFloat(val || 0)); }
        function parseInput(val) { return parseInt((val || '').toString().replace(/[\$\.\s]/g, '')) || 0; }
        function fmt(val) { return Math.floor(val).toLocaleString('es-CL'); }
        function formatInput(input) { let val = input.value.replace(/\D/g, ''); input.value = val.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
            applyFilters();
        }

        function openCRMModal() { document.getElementById('modal-crm').classList.add('show'); loadInitialData(); }
        function closeModal(id) { 
            document.getElementById(`modal-${id}`).classList.remove('show'); 
            if(id === 'crm') { document.getElementById('crm-form').reset(); resetFinanceFields(); }
        }
        
        function resetFinanceFields() {
            document.getElementById('reserva-found-msg').style.display = 'none';
            document.getElementById('input-monto-reserva').disabled = false;
            document.getElementById('select-cliente').disabled = false;
            document.getElementById('input-precio-acordado').value = '';
            document.getElementById('input-monto-reserva').value = '';
            document.getElementById('disp-total-pagar').innerText = '$0';
        }

        function setType(type) {
            document.getElementById('action-type').value = type;
            document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-type-${type}`).classList.add('active');
            const isVisita = type === 'visita';
            document.getElementById('fields-visita').style.display = isVisita ? 'block' : 'none';
            document.getElementById('fields-finance').style.display = isVisita ? 'none' : 'block';
            document.getElementById('group-lote').style.visibility = isVisita ? 'hidden' : 'visible'; 
            
            if (type === 'reserva') {
                document.getElementById('group-precio-acordado').style.display = 'none'; 
                document.getElementById('label-reserva').innerText = "Monto a Pagar para Reservar";
                document.getElementById('label-total').innerText = "Total Reserva:";
            } else if (type === 'venta') {
                document.getElementById('group-precio-acordado').style.display = 'block';
                document.getElementById('label-reserva').innerText = "Menos Reserva (Ya pagada)";
                document.getElementById('label-total').innerText = "Restante a Pagar:";
            }
            handleLoteChange();
        }

        async function loadInitialData() {
            // FIX: Reemplazar fetch local por fetch a API_URL
            const [proyectos, clientes] = await Promise.all([
                fetch(`${API_URL}/projects`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                fetch(`${API_URL}/crm/clientes`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
            ]);
            const selP = document.getElementById('select-proyecto'); selP.innerHTML = '<option value="">Selecciona...</option>';
            const filterP = document.getElementById('filter-proyecto'); filterP.innerHTML = '<option value="">Todos los Proyectos</option>';
            proyectos.forEach(p => {
                selP.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
                filterP.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
            });
            const selC = document.getElementById('select-cliente'); selC.innerHTML = '<option value="">Selecciona cliente...</option>';
            clientes.forEach(c => selC.innerHTML += `<option value="${c.id}">${c.nombre} (${c.rut || 'S/R'})</option>`);
        }

        async function loadLotes(projectId) {
            if(!projectId) return;
            const sel = document.getElementById('select-lote'); sel.disabled = true; sel.innerHTML = '<option>Cargando...</option>';
            // FIX: Reemplazar fetch local por fetch a API_URL
            const res = await fetch(`${API_URL}/lotes/${projectId}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            lotesData = data.filter(l => l.tipo === 'lote');
            sel.innerHTML = '<option value="">Selecciona lote...</option>';
            lotesData.forEach(l => {
                const type = document.getElementById('action-type').value;
                if (type === 'reserva' && l.estado_id !== 1) return;
                if (type === 'venta' && l.estado_id === 3) return; 
                const icon = l.estado_id === 1 ? '' : (l.estado_id === 2 ? '' : '');
                sel.innerHTML += `<option value="${l.id}">Lote ${l.numero_lote} (${icon})</option>`;
            });
            sel.disabled = false;
        }

        async function handleLoteChange() {
            resetFinanceFields();
            const loteId = document.getElementById('select-lote').value;
            const type = document.getElementById('action-type').value;
            if (!loteId) return updateCalculations();
            
            const lote = lotesData.find(l => l.id == loteId);
            if(lote) {
                document.getElementById('disp-precio-lista').innerText = `$${fmt(parseDB(lote.precio))}`;
            }

            if (type === 'venta') {
                try {
                    // FIX: Reemplazar fetch local por fetch a API_URL
                    const res = await fetch(`${API_URL}/crm/reserva/${loteId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const reserva = await res.json();
                    if (reserva) {
                        document.getElementById('reserva-found-msg').style.display = 'flex';
                        document.getElementById('select-cliente').value = reserva.cliente_id;
                        document.getElementById('select-cliente').disabled = true; 
                        document.getElementById('input-monto-reserva').value = fmt(parseDB(reserva.valor_final)); 
                        document.getElementById('input-monto-reserva').disabled = true;
                    }
                } catch (e) { console.error(e); }
            }
            updateCalculations();
        }

        function updateCalculations() {
            const type = document.getElementById('action-type').value;
            const precioLista = parseInput(document.getElementById('disp-precio-lista').innerText);

            if (type === 'reserva') {
                const monto = parseInput(document.getElementById('input-monto-reserva').value);
                document.getElementById('disp-total-pagar').innerText = `$${fmt(monto)}`;
            } 
            else if (type === 'venta') {
                const precioAcordadoInput = document.getElementById('input-precio-acordado');
                let precioAcordado = parseInput(precioAcordadoInput.value);
                if (precioAcordado === 0 && precioAcordadoInput.value === '') { precioAcordado = precioLista; }
                const reserva = parseInput(document.getElementById('input-monto-reserva').value);
                const restante = Math.max(0, precioAcordado - reserva);
                document.getElementById('disp-total-pagar').innerText = `$${fmt(restante)}`;
            }
        }

        document.getElementById('crm-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('action-type').value;
            const body = {
                cliente_id: document.getElementById('select-cliente').value,
                proyecto_id: document.getElementById('select-proyecto').value,
                lote_id: document.getElementById('select-lote').value || null,
                notas: document.getElementById('notas').value
            };
            
            if (type === 'visita') {
                body.fecha_visita = `${document.getElementById('fecha-input').value}T${document.getElementById('hora-input').value}:00`;
                // FIX: Reemplazar fetch local por fetch a API_URL
                await fetch(`${API_URL}/crm/visitas`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
            } else {
                if(!body.lote_id) return alert('Selecciona un lote.');
                
                body.tipo_operacion = type; 
                body.precio_lista = parseInput(document.getElementById('disp-precio-lista').innerText);
                body.monto_reserva = parseInput(document.getElementById('input-monto-reserva').value);
                body.metodo_pago = document.getElementById('metodo-pago').value;
                
                if (type === 'venta') {
                    const inputAcordado = document.getElementById('input-precio-acordado').value;
                    body.precio_acordado = inputAcordado ? parseInput(inputAcordado) : body.precio_lista;
                    body.valor_final = parseInput(document.getElementById('disp-total-pagar').innerText); 
                } else {
                    body.precio_acordado = body.precio_lista; 
                    body.valor_final = body.monto_reserva; 
                }

                // FIX: Reemplazar fetch local por fetch a API_URL
                await fetch(`${API_URL}/crm/ventas`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(body) });
            }
            closeModal('crm');
            fetchAllData(); 
        });

        async function fetchAllData() {
            try {
                // FIX: Reemplazar fetch local por fetch a API_URL
                const [visitas, ventas] = await Promise.all([
                    fetch(`${API_URL}/crm/visitas`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json()),
                    fetch(`${API_URL}/crm/ventas`, { headers: { 'Authorization': `Bearer ${token}` } }).then(r => r.json())
                ]);
                visitasData = visitas;
                ventasData = ventas;
                applyFilters();
            } catch (e) {
                 document.getElementById('ventas-tbody').innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px; color:#ef4444;">Error al cargar datos: El servidor no responde.</td></tr>';
            }
        }

        function applyFilters() {
            const filterVal = document.getElementById('filter-proyecto').value;
            const data = currentTab === 'visitas' ? visitasData : ventasData;
            const filtered = filterVal ? data.filter(i => i.proyecto_id == filterVal) : data;
            if(currentTab === 'visitas') renderVisitas(filtered); else renderVentas(filtered);
        }

        function renderVisitas(data) {
            const grid = document.getElementById('visitas-grid'); grid.innerHTML = '';
            if(data.length===0) return grid.innerHTML = '<div class="alert">No hay visitas.</div>';
            data.forEach(v => {
                grid.innerHTML += `<div class="project-card" style="border-left:5px solid #2563eb;"><div class="card-body"><div style="color:#2563eb;font-weight:700;font-size:0.8rem;">${v.proyecto_nombre}</div><h3 style="margin:5px 0;">${v.cliente_nombre}</h3><p style="color:#64748b;font-size:0.9rem;">${v.numero_lote ? 'Inter茅s: Lote '+v.numero_lote : 'Visita General'}</p><div style="background:#f1f5f9;padding:8px;border-radius:8px;font-size:0.85rem;"><i class="bi bi-clock"></i> ${new Date(v.fecha_visita).toLocaleString()}</div></div></div>`;
            });
        }

        function renderVentas(data) {
            const tbody = document.getElementById('ventas-tbody'); tbody.innerHTML = '';
            if(data.length===0) return tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:30px;">No hay operaciones.</td></tr>';
            
            data.forEach((v) => {
                const tipoBadge = v.tipo_operacion === 'reserva' 
                    ? '<span style="background:#fef3c7;color:#d97706;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:700;">RESERVA</span>' 
                    : '<span style="background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;font-size:0.7rem;font-weight:700;">VENTA</span>';
                
                const totalOp = fmt(parseDB(v.precio_acordado) || parseDB(v.precio_lista));
                const pagado = fmt(parseDB(v.valor_final));
                const jsonData = JSON.stringify(v).replace(/"/g, '&quot;');

                tbody.innerHTML += `<tr><td>${new Date(v.fecha_venta).toLocaleDateString()}</td><td>${tipoBadge}</td><td><strong>${v.cliente_nombre}</strong></td><td>${v.proyecto_nombre}</td><td>Lote ${v.numero_lote}</td><td style="text-align:right;">$${totalOp}</td><td style="text-align:right; font-weight:700; color:#166534;">$${pagado}</td><td style="text-align:center;"><button class="btn-icon-info" onclick="viewSaleDetails(${jsonData})"><i class="bi bi-eye-fill"></i></button></td></tr>`;
            });
        }

        function viewSaleDetails(v) {
            const body = document.getElementById('info-body');
            const typeLabel = v.tipo_operacion === 'venta' ? 'Venta Final' : 'Reserva';
            body.innerHTML = `
                <div class="info-group">
                    <div class="info-row"><span class="info-label">Tipo</span><span class="info-val">${typeLabel}</span></div>
                    <div class="info-row"><span class="info-label">Fecha</span><span class="info-val">${new Date(v.fecha_venta).toLocaleString()}</span></div>
                </div>
                <div class="info-group">
                    <div class="info-row"><span class="info-label">Cliente</span><span class="info-val">${v.cliente_nombre}</span></div>
                    <div class="info-row"><span class="info-label">Proyecto</span><span class="info-val">${v.proyecto_nombre}</span></div>
                    <div class="info-row"><span class="info-label">Lote</span><span class="info-val">${v.numero_lote}</span></div>
                </div>
                <div class="info-group">
                    <div class="info-row"><span class="info-label">Precio Lista</span><span class="info-val">$${fmt(parseDB(v.precio_lista))}</span></div>
                    <div class="info-row"><span class="info-label">Precio Acordado</span><span class="info-val">$${fmt(parseDB(v.precio_acordado))}</span></div>
                    <div class="info-total"><span>PAGADO:</span><span>$${fmt(parseDB(v.valor_final))}</span></div>
                </div>
            `;
            document.getElementById('modal-info').classList.add('show');
        }
    </script>
</body>
</html>